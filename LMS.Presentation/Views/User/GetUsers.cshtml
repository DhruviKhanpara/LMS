@using LMS.Presentation.HTMLHelper;
@using LMS.Core.Enums;

@model LMS.Application.Contracts.DTOs.PaginatedResponseDto<LMS.Application.Contracts.DTOs.User.GetUserDto>

@{
    ViewData["Title"] = "GetUsers";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    th {
        position: relative;
    }
</style>

<script src="~/js/sorting.js" asp-append-version="true"></script>
<script src="~/js/filesetting.js" asp-append-version="true"></script>

@Html.Heading("User Information")
<div class="container-fluid my-1">
    <div class="d-flex justify-content-end px-3 my-3 gap-3">
        <div>
            <a class="btn btn-submit color-purple" id="user-add-btn">Create Account</a>
        </div>
        <div>
            <a asp-area="" asp-controller="User" asp-action="GetExportUsers" class="btn btn-submit color-purple">Export Users</a>
        </div>
        @if (User.Identity.IsAuthenticated && User.IsInRole(nameof(RoleListEnum.Admin)))
        {
            <script src="~/js/filterSelector.js" asp-append-version="true"></script>
            <div class="did-floating-label-content m-0 w-15">
                <select class="did-floating-select select2-single filter-options" data-params="activeData" id="data-selection-option" value="">
                    <option value="">Removed and Active Data</option>
                    <option value="true">Active Data</option>
                    <option value="false">Removed Data</option>
                </select>
            </div>
        }
    </div>
    <div class="table-responsive scrollable-table">
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                    <th class="sortable-header" data-field="FirstName">First Name</th>
                    <th class="sortable-header" data-field="MiddleName">Middle Name</th>
                    <th class="sortable-header" data-field="LastName">Last Name</th>
                    <th class="sortable-header text-center" data-field="Role">Role</th>
                    <th class="sortable-header text-center" data-field="JoiningDate">Joining Date</th>
                    <th class="sortable-header text-center" data-field="LibraryCardNumber">Library card Number</th>
                    <th class="sortable-header text-center" data-field="Gender">Gender</th>
                    <th class="sortable-header" data-field="Username">Username</th>
                    <th class="sortable-header text-center" data-field="HasPenalty">Has Penalty?</th>
                    <th class="sortable-header text-center" data-field="HasOccupiedBook">Occupied Book?</th>
                    <th class="sortable-header text-center" data-field="Dob">Date of Birth</th>
                    <th class="sortable-header text-center" data-field="MobileNo">Mobile Number</th>
                    <th class="sortable-header" data-field="Email">E-mail</th>
                    <th class="sortable-header" data-field="Address">Address</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Data is not null && Model.Data.Any())
                {
                    @foreach (var item in Model.Data)
                    {
                        <tr class="@(item.IsRemoved ? "bg-color-danger" : "bg-color-default")">
                            <td>
                                <div class="d-flex justify-content-between gap-3 user-details-table">
                                    @if (User.Identity.IsAuthenticated && (User.IsInRole(nameof(RoleListEnum.Librarian)) || User.IsInRole(nameof(RoleListEnum.Admin))) && !item.IsRemoved)
                                    {
                                        <a class="color-purple bi-hover-bold user-actionById-btn" 
                                            asp-area=""
                                            asp-controller="User" 
                                            asp-action="GetUserDetailById"
                                            data-user-id="@item.Id"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            title="Detail">
                                        <i class="bi bi-exclamation-circle"></i></a>

                                        <a class="color-purple bi-hover-bold user-actionById-btn" 
                                            asp-area="" 
                                            asp-controller="User" 
                                            asp-action="UpdateUser"
                                            data-user-id="@item.Id" 
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right" 
                                            title="Edit">
                                        <i class="bi bi-pencil-square"></i></a>

                                        <a class="color-purple bi-hover-bold user-delete-btn"
                                            asp-area=""
                                            asp-controller="User" 
                                            asp-action="DeleteUser" 
                                            data-user-id="@item.Id" 
                                            data-bs-toggle="tooltip" 
                                            data-bs-placement="right" 
                                            title="Delete">
                                        <i class="bi bi-trash3"></i></a>

                                        <a class="color-purple bi-hover-bold user-action-btn"
                                            asp-area=""
                                            asp-controller="User"
                                            asp-action="AuthChangePassword" 
                                            data-bs-toggle="tooltip" 
                                            data-bs-placement="right" 
                                            title="Update password">
                                        <i class="bi bi-shield-lock"></i></a>

                                        <a class="color-purple bi-hover-bold libraryCard-download"
                                            asp-area=""
                                            asp-controller="User"
                                            asp-action="DownloadLibraryCard" 
                                            data-user-id="@item.Id"
                                            data-bs-toggle="tooltip" 
                                            data-bs-placement="right" 
                                            title="Download Library card">
                                        <i class="bi bi-person-badge"></i></a>
                                    }

                                    @if (User.Identity.IsAuthenticated && User.IsInRole(nameof(RoleListEnum.Admin)))
                                    {
                                        <a class="color-purple bi-hover-bold user-actionById-btn"
                                            asp-area=""
                                            asp-controller="Log"
                                            asp-action="GetUserAuditHistoryByUserId"
                                            data-user-id="@item.Id"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="right"
                                            title="History">
                                        <i class="bi bi-clock-history"></i></a>

                                        @if (item.IsRemoved)
                                        {
                                            @* restore *@
                                        }
                                    }

                                    <a class="color-purple bi-hover-bold user-redirect-btn" 
                                        asp-area="" 
                                        asp-controller="Transection" 
                                        asp-action="GetTransections" 
                                        data-user-id="@item.Id" 
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="right"
                                        title="Check-outs">
                                    <i class="bi bi-cart3"></i></a>

                                    <a class="color-purple bi-hover-bold user-redirect-btn"
                                        asp-area="" 
                                        asp-controller="Reservation"
                                        asp-action="GetReservations"
                                        data-user-id="@item.Id"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="right"
                                        title="Reservation">
                                    <i class="bi bi-journal-check"></i></a>
                                </div>
                            </td>
                            <td>
                                <img src="@item.ProfilePhoto" alt="User" width="20" height="20" class="rounded-circle cursor-pointer border-dark border-1 mx-1" onclick="showDocumentModal('@item.ProfilePhoto')" /> @Html.DisplayFor(modelItem => item.FirstName)
                            </td>
                            <td>
                                @(item.MiddleName != null ? Html.DisplayFor(modelItem => item.MiddleName) : "-")
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.LastName)
                            </td>
                            <td class="text-center">
                                @Html.DisplayFor(modelItem => item.Role)
                            </td>
                            <td class="text-center">
                                @item.JoiningDate.DateTime.ToString("dd-MM-yyyy hh:mm:ss tt")
                            </td>
                            <td class="text-center">
                                @(item.LibraryCardNumber != null ? Html.DisplayFor(modelItem => item.LibraryCardNumber) : "-")
                            </td>
                            <td class="text-center">
                                @Html.DisplayFor(modelItem => item.Gender)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Username)
                            </td>
                            <td class="text-center">
                                @if (item.HasPenalty == true)
                                {
                                    <i class="bi bi-check2 color-purple"></i>
                                }
                                else
                                {
                                    <i class="bi bi-x-lg color-purple"></i>
                                }
                            </td>
                            <td class="text-center">
                                @if (item.HasOccupiedBook == true)
                                {
                                    <i class="bi bi-check2 color-purple"></i>
                                }
                                else
                                {
                                    <i class="bi bi-x-lg color-purple"></i>
                                }
                            </td>
                            <td class="text-center">
                                @Html.DisplayFor(modelItem => item.Dob)
                            </td>
                            <td class="text-center">
                                @Html.DisplayFor(modelItem => item.MobileNo)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Email)
                            </td>
                            <td class="truncate-description-container" data-max-length="40" data-bs-toggle="tooltip" data-bs-placement="right" title="@item.Address">
                                @Html.DisplayFor(modelItem => item.Address)
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="15" class="text-center border-0">No records found</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    @{
        await Html.RenderPartialAsync("_PaginationPartial", Model.Pagination);
    }
</div>

<div id="userContainer"></div>
<div id="confirmationModalContainer">
    @await Html.PartialAsync("_ConfirmationBoxModelPartial")
</div>
<div id="imageModalContainer">
    @Html.TransparentModal()
</div>

<script>
    $(document).ready(function ()
    {
        var successToastMessage = '@TempData["SuccessToast"]';
        var errorToastMessage = '@TempData["ErrorToast"]';

        if (successToastMessage)
        {
            toastr.success(successToastMessage, "Success");
        }
        else if (errorToastMessage)
        {
            toastr.error(errorToastMessage, "Error");
        }

        var resourceLookup = @Html.Raw(Json.Serialize(Model.Data?.ToDictionary(m => m.Id, m => m.HasPenalty || m.HasOccupiedBook)));
        var userRoleLookup = @Html.Raw(Json.Serialize(Model.Data?.ToDictionary(m => m.Id, m => m.RoleId == (long)RoleListEnum.User)));

        $(".user-delete-btn").each(function ()
        {
            var userId = $(this).data("user-id");
            var hasResource = resourceLookup[userId];

            if (hasResource)
            {
                $(this).addClass("btn-submit-disabled")
                    .attr("title", "Disabled due to user occupied resources or may have penalty")
                    .removeAttr("data-user-id");
            }
        });

        $(".user-redirect-btn, .libraryCard-download").each(function ()
        {
            var userId = $(this).data("user-id");
            var isUser = userRoleLookup[userId];

            if (!isUser)
            {
                $(this).addClass("btn-submit-disabled")
                    .attr("title", "Disabled due to only user account have this redirections")
                    .removeAttr("data-user-id");
            }
        });

        $('#user-add-btn').off("click").on("click", function ()
        {
            event.preventDefault();
            toggleButtonState('#user-add-btn', true, 'color-purple btn-submit');

            $.ajax({
                url: '@Url.Action("AddUser", "User")',
                type: 'GET',
                contentType: 'application/json',
                success: function (result)
                {
                    $('#userContainer').html(result);
                }
            });
            toggleButtonState('#user-add-btn', false, 'color-purple btn-submit');
        });

        $('.user-details-table .user-delete-btn').off("click").on("click", function (event)
        {
            event.preventDefault();
            $(this).addClass("btn-submit-disabled");

            var userId = $(this).data('user-id');

            if (userId !== undefined)
            {
                var message = "Are you sure you want delete this user? \n This User may have active membership or may have reservation user may lost it";
                setProceedButtonHref(this, message, "id=" + userId);
            }

            $(this).removeClass("btn-submit-disabled");
        })

        $('.user-details-table .user-actionById-btn').off("click").on("click", function (event)
        {
            event.preventDefault();
            $(this).addClass("btn-submit-disabled");

            var userId = $(this).data('user-id');

            if (userId !== undefined)
            {
                $.ajax({
                    url: $(this).attr("href"),
                    data: { id: userId },
                    type: 'GET',
                    contentType: 'application/json',
                    success: function (result)
                    {
                        $('#userContainer').html(result);
                    }
                });
            }

            $(this).removeClass("btn-submit-disabled");
        });

        $('.user-details-table .user-redirect-btn').off("click").on("click", function (event)
        {
            event.preventDefault();
            $(this).addClass("btn-submit-disabled")

            var userId = $(this).data('user-id');

            if (userId !== undefined)
            {
                var url = $(this).attr("href") + "?user=" + userId;
                window.location.href = url.toString();
            }

            $(this).removeClass("btn-submit-disabled");
        });

        $('.user-details-table .user-action-btn').off("click").on("click", function (event)
        {
            event.preventDefault();
            $(this).addClass("btn-submit-disabled")
            
            $.ajax({
                url: $(this).attr("href"),
                type: 'GET',
                contentType: 'application/json',
                success: function (result)
                {
                    $('#userContainer').html(result);
                }
            });

            $(this).removeClass("btn-submit-disabled");
        });

        $('.libraryCard-download').off("click").on("click", function (event)
        {
            console.log("hry");
            event.preventDefault();
            $(this).addClass("btn-submit-disabled");

            var userId = $(this).data('user-id');
            var url = $(this).attr('href');

            console.log(userId);

            const link = document.createElement('a');
            link.href = url + "?userId=" + userId;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            $(this).removeClass("btn-submit-disabled");

            toastr.success("You get you Library card in the download folder.", "Success");
        });
    });
</script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}